{% extends 'base.html.twig' %}

{% block title %}Gestion des Utilisateurs - Admin{% endblock %}

{% block stylesheets %}
<style>
    .admin-header {
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        border-radius: 20px;
        padding: 2.5rem;
        margin-bottom: 2rem;
        color: white;
        box-shadow: 0 10px 40px rgba(99, 102, 241, 0.3);
    }
    
    .modern-tabs {
        background: white;
        border-radius: 16px;
        padding: 0.75rem;
        box-shadow: 0 2px 10px rgba(0,0,0,0.06);
        border: none;
        margin-bottom: 2rem;
    }
    
    .modern-tabs .nav-link {
        border: none;
        border-radius: 12px;
        color: #64748b;
        font-weight: 600;
        padding: 0.875rem 1.75rem;
        margin: 0 0.25rem;
        transition: all 0.3s ease;
    }
    
    .modern-tabs .nav-link:hover {
        background: #f1f5f9;
        color: #6366f1;
    }
    
    .modern-tabs .nav-link.active {
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        color: white;
        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
    }
    
    .modern-card {
        border: none;
        border-radius: 20px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.06);
        overflow: hidden;
    }
    
    .modern-card-header {
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        border: none;
        padding: 1.75rem;
    }
    
    .modern-card-header h5 {
        color: #475569;
        margin: 0;
        font-weight: 700;
    }
    
    .user-card {
        background: white;
        border-radius: 16px;
        padding: 1.75rem;
        margin-bottom: 1rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        transition: all 0.3s ease;
        border-left: 4px solid transparent;
    }
    
    .user-card:hover {
        transform: translateX(6px);
        box-shadow: 0 8px 24px rgba(0,0,0,0.08);
    }
    
    .user-card.status-banned {
        border-left-color: #ef4444;
        background: linear-gradient(to right, #fef2f2 0%, white 8%);
    }
    
    .user-card.status-pending {
        border-left-color: #f59e0b;
        background: linear-gradient(to right, #fffbeb 0%, white 8%);
    }
    
    .user-card.status-approved {
        border-left-color: #22d3ee;
    }
    
    .user-avatar {
        width: 60px;
        height: 60px;
        border-radius: 16px;
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.85rem;
        flex-shrink: 0;
        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.25);
    }
    
    .status-badge {
        padding: 0.5rem 1rem;
        border-radius: 10px;
        font-weight: 600;
        font-size: 0.875rem;
    }
    
    .status-approved {
        background: #22d3ee;
        color: #164e63;
    }
    
    .status-pending {
        background: #f59e0b;
        color: white;
    }
    
    .status-banned {
        background: #ef4444;
        color: white;
    }
    
    .modern-btn {
        border-radius: 10px;
        font-weight: 600;
        padding: 0.625rem 1.5rem;
        transition: all 0.3s ease;
        border: none;
    }
    
    .modern-btn-primary {
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        color: white;
    }
    
    .modern-btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(99, 102, 241, 0.35);
    }
    
    .modern-btn-danger {
        background: #ef4444;
        color: white;
    }
    
    .modern-btn-danger:hover {
        background: #dc2626;
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(239, 68, 68, 0.35);
    }
    
    .modern-btn-success {
        background: #22d3ee;
        color: #164e63;
    }
    
    .modern-btn-success:hover {
        background: #06b6d4;
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(34, 211, 238, 0.35);
    }
    
    .warning-badge {
        background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
        color: white;
        padding: 0.375rem 0.875rem;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.875rem;
    }
    
    .report-card {
        border-left: 4px solid #ef4444;
        border-radius: 16px;
        transition: all 0.3s ease;
    }
    
    .report-card:hover {
        transform: translateX(6px);
        box-shadow: 0 8px 25px rgba(239, 68, 68, 0.15);
    }
    
    .badge-role {
        padding: 0.375rem 0.875rem;
        border-radius: 8px;
        font-weight: 600;
        font-size: 0.8125rem;
    }
    
    .badge-admin {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
    }
    
    .badge-user {
        background: linear-gradient(135deg, #22d3ee 0%, #06b6d4 100%);
        color: #164e63;
    }
    
    .badge-visitor {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        color: white;
    }
    
    .pagination-modern {
        display: flex;
        gap: 0.5rem;
        justify-content: center;
        margin-top: 2rem;
    }
    
    .pagination-modern .page-item {
        list-style: none;
    }
    
    .pagination-modern .page-link {
        border: none;
        border-radius: 10px;
        padding: 0.625rem 1rem;
        color: #64748b;
        font-weight: 600;
        transition: all 0.3s ease;
        background: white;
        box-shadow: 0 2px 6px rgba(0,0,0,0.04);
    }
    
    .pagination-modern .page-link:hover {
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
    }
    
    .pagination-modern .page-item.active .page-link {
        background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        color: white;
        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
    }
    
    .pagination-modern .page-item.disabled .page-link {
        background: transparent;
        color: #cbd5e1;
        box-shadow: none;
        cursor: default;
    }
    
    .pagination-modern .page-item.disabled .page-link:hover {
        transform: none;
        background: transparent;
    }
</style>
{% endblock %}

{% block body %}
<div class="container-fluid px-4">
    <!-- Header moderne -->
    <div class="admin-header animate-fade-in">
        <div class="d-flex align-items-center justify-content-between">
            <div>
                <h1 class="mb-2">
                    <i class="bi bi-shield-shaded me-3"></i>
                    Panneau d'Administration
                </h1>
                <p class="mb-0 opacity-75">Gérez les utilisateurs, signalements et suggestions</p>
            </div>
            <div class="text-end">
                <div class="fs-4 fw-bold">{{ users|length }}</div>
                <small class="opacity-75">Utilisateurs</small>
            </div>
        </div>
    </div>

    <!-- Navigation des onglets moderne -->
    <ul class="nav modern-tabs" id="adminTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="users-tab" data-bs-toggle="tab" data-bs-target="#users" type="button" role="tab">
                        <i class="bi bi-people me-1"></i>
                        Utilisateurs ({{ users|length }})
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="reports-tab" data-bs-toggle="tab" data-bs-target="#reports" type="button" role="tab">
                        <i class="bi bi-flag me-1"></i>
                        Signalements ({{ pendingReports|length }})
                        {% if pendingReports|length > 0 %}
                            <span class="badge bg-danger">{{ pendingReports|length }}</span>
                        {% endif %}
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <a href="{{ path('admin_reports') }}" class="nav-link">
                        <i class="bi bi-flag-fill me-1"></i>
                        Voir tous les signalements
                    </a>
                </li>
                <li class="nav-item" role="presentation">
                    <a href="{{ path('admin_category_suggestions') }}" class="nav-link">
                        <i class="bi bi-lightbulb me-1"></i>
                        Suggestions
                    </a>
                </li>
            </ul>

            <div class="tab-content" id="adminTabsContent">
                <!-- Onglet Utilisateurs -->
                <div class="tab-pane fade show active" id="users" role="tabpanel">
                    <div class="modern-card">
                        <div class="modern-card-header">
                            <h5 class="mb-0 fw-bold">
                                <i class="bi bi-people me-2"></i>
                                Liste des Utilisateurs ({{ users|length }})
                            </h5>
                        </div>
                        <div class="card-body p-4">
                            {% for user in users %}
                                <div class="user-card {% if user.isBanned %}status-banned{% elseif not user.isAccepted %}status-pending{% else %}status-approved{% endif %}">
                                    <div class="row align-items-center">
                                        <div class="col-auto">
                                            <div class="user-avatar">
                                                <i class="bi bi-person-fill"></i>
                                            </div>
                                        </div>
                                        <div class="col">
                                            <div class="d-flex align-items-center mb-2">
                                                <h6 class="mb-0 me-3">{{ user.firstName }} {{ user.lastName }}</h6>
                                                {% if 'ROLE_ADMIN' in user.roles %}
                                                    <span class="badge badge-role badge-admin me-2">
                                                        <i class="bi bi-shield-fill me-1"></i>ADMIN
                                                    </span>
                                                {% elseif 'ROLE_USER' in user.roles %}
                                                    <span class="badge badge-role badge-user me-2">
                                                        <i class="bi bi-person-check me-1"></i>USER
                                                    </span>
                                                {% else %}
                                                    <span class="badge badge-role badge-visitor me-2">
                                                        <i class="bi bi-person-plus me-1"></i>VISITOR
                                                    </span>
                                                {% endif %}
                                                
                                                {% if user.isBanned %}
                                                    <span class="status-badge status-banned">
                                                        <i class="bi bi-ban me-1"></i>Banni
                                                    </span>
                                                {% elseif user.isAccepted %}
                                                    <span class="status-badge status-approved">
                                                        <i class="bi bi-check-circle me-1"></i>Actif
                                                    </span>
                                                {% else %}
                                                    <span class="status-badge status-pending">
                                                        <i class="bi bi-clock me-1"></i>En attente
                                                    </span>
                                                {% endif %}
                                            </div>
                                            <div class="d-flex align-items-center text-muted small">
                                                <i class="bi bi-envelope me-2"></i>
                                                <span class="me-4">{{ user.email }}</span>
                                                <i class="bi bi-calendar me-2"></i>
                                                <span class="me-4">{{ user.createdAt|date('d/m/Y') }}</span>
                                                <span class="warning-badge">
                                                    <i class="bi bi-exclamation-triangle me-1"></i>{{ user.warningCount }}/3
                                                </span>
                                            </div>
                                        </div>
                                        <div class="col-auto">
                                            {% if user != app.user %}
                                                <div class="d-flex gap-2">
                                                    {% if not user.isAccepted and not user.isBanned %}
                                                        <a href="{{ path('admin_user_approve', {id: user.id}) }}" 
                                                           class="btn modern-btn modern-btn-success"
                                                           onclick="return confirm('Approuver cet utilisateur ?')">
                                                            <i class="bi bi-check-lg me-1"></i>Approuver
                                                        </a>
                                                    {% endif %}
                                                    
                                                    {% if user.isBanned %}
                                                        <form method="post" action="{{ path('admin_user_unban', {id: user.id}) }}" class="d-inline">
                                                            <button type="submit" class="btn modern-btn modern-btn-primary"
                                                                    onclick="return confirm('Débannir cet utilisateur ?')">
                                                                <i class="bi bi-unlock me-1"></i>Débannir
                                                            </button>
                                                        </form>
                                                    {% else %}
                                                        <button type="button" class="btn modern-btn modern-btn-danger" 
                                                                data-bs-toggle="modal" 
                                                                data-bs-target="#banModal{{ user.id }}">
                                                            <i class="bi bi-ban me-1"></i>Bannir
                                                        </button>
                                                    {% endif %}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>

                                            <!-- Modal de bannissement -->
                                            <div class="modal fade" id="banModal{{ user.id }}" tabindex="-1">
                                                <div class="modal-dialog">
                                                    <div class="modal-content">
                                                        <div class="modal-header">
                                                            <h5 class="modal-title">Bannir l'utilisateur</h5>
                                                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                                        </div>
                                                        <form method="post" action="{{ path('admin_user_ban', {id: user.id}) }}">
                                                            <div class="modal-body">
                                                                <p>Voulez-vous vraiment bannir <strong>{{ user.firstName }} {{ user.lastName }}</strong> ?</p>
                                                                <div class="mb-3">
                                                                    <label class="form-label">Raison du bannissement</label>
                                                                    <textarea name="reason" class="form-control" rows="3" 
                                                                              placeholder="Décrivez la raison du bannissement..."></textarea>
                                                                </div>
                                                            </div>
                                                            <div class="modal-footer">
                                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                                                                <button type="submit" class="btn btn-danger">Bannir</button>
                                                            </div>
                                                        </form>
                                                    </div>
                                                </div>
                                            </div>
                                        {% endfor %}
                            
                            <!-- Pagination -->
                            {% if totalPages > 1 %}
                            <nav aria-label="Pagination">
                                <ul class="pagination pagination-modern">
                                    {% if currentPage > 1 %}
                                    <li class="page-item">
                                        <a class="page-link" href="{{ path('admin_users', {page: currentPage - 1}) }}" aria-label="Précédent">
                                            <i class="bi bi-chevron-left"></i>
                                        </a>
                                    </li>
                                    {% endif %}
                                    
                                    {% for page in 1..totalPages %}
                                        {% if page == currentPage %}
                                            <li class="page-item active"><span class="page-link">{{ page }}</span></li>
                                        {% elseif page == 1 or page == totalPages or (page >= currentPage - 1 and page <= currentPage + 1) %}
                                            <li class="page-item"><a class="page-link" href="{{ path('admin_users', {page: page}) }}">{{ page }}</a></li>
                                        {% elseif page == currentPage - 2 or page == currentPage + 2 %}
                                            <li class="page-item disabled"><span class="page-link">...</span></li>
                                        {% endif %}
                                    {% endfor %}
                                    
                                    {% if currentPage < totalPages %}
                                    <li class="page-item">
                                        <a class="page-link" href="{{ path('admin_users', {page: currentPage + 1}) }}" aria-label="Suivant">
                                            <i class="bi bi-chevron-right"></i>
                                        </a>
                                    </li>
                                    {% endif %}
                                </ul>
                            </nav>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Onglet Signalements -->
                <div class="tab-pane fade" id="reports" role="tabpanel">
                    <div class="modern-card">
                        <div class="modern-card-header">
                            <h5 class="mb-0 fw-bold">
                                <i class="bi bi-flag me-2"></i>
                                Signalements en attente
                            </h5>
                        </div>
                        <div class="card-body">
                            {% if pendingReports %}
                                <div class="row g-4">
                                    {% for report in pendingReports %}
                                        <div class="col-12">
                                            <div class="card report-card border-0 shadow-sm">
                                                <div class="card-body p-4">
                                                    <div class="row">
                                                        <div class="col-md-8">
                                                            <div class="d-flex align-items-start mb-3">
                                                                <div class="user-avatar me-3" style="width: 40px; height: 40px; font-size: 1.2rem;">
                                                                    <i class="bi bi-flag-fill"></i>
                                                                </div>
                                                                <div>
                                                                    <h6 class="mb-1">Signalé par {{ report.reportedBy.firstName }} {{ report.reportedBy.lastName }}</h6>
                                                                    <small class="text-muted">
                                                                        <i class="bi bi-clock me-1"></i>
                                                                        {{ report.reportedAt|date('d/m/Y à H:i') }}
                                                                    </small>
                                                                    <span class="badge bg-warning ms-2">{{ report.reportCategory }}</span>
                                                                </div>
                                                            </div>
                                                            
                                                            <div class="bg-light p-3 rounded-3 mb-3">
                                                                <strong class="text-muted d-block mb-2">Commentaire signalé :</strong>
                                                                <p class="mb-2">{{ report.comment.content }}</p>
                                                                <small class="text-muted">
                                                                    Par <strong>{{ report.comment.user.firstName }} {{ report.comment.user.lastName }}</strong>
                                                                    le {{ report.comment.createdAt|date('d/m/Y') }}
                                                                </small>
                                                            </div>
                                                            
                                                            {% if report.reason %}
                                                                <div class="alert alert-warning mb-0">
                                                                    <strong>Raison :</strong> {{ report.reason }}
                                                                </div>
                                                            {% endif %}
                                                        </div>
                                                        <div class="col-md-4">
                                                            <div class="d-grid gap-2">
                                                                <button type="button" class="btn modern-btn" 
                                                                        style="background: #f59e0b; color: white;"
                                                                        data-bs-toggle="modal" 
                                                                        data-bs-target="#warnModal{{ report.id }}">
                                                                    <i class="bi bi-exclamation-triangle me-2"></i>
                                                                    Avertir ({{ report.comment.user.warningCount }}/3)
                                                                </button>

                                                                <button type="button" class="btn modern-btn modern-btn-danger" 
                                                                        data-bs-toggle="modal" 
                                                                        data-bs-target="#banReportModal{{ report.id }}">
                                                                    <i class="bi bi-ban me-2"></i>
                                                                    Bannir
                                                                </button>

                                                                <a href="{{ path('admin_report_dismiss', {id: report.id}) }}" 
                                                                   class="btn btn-outline-secondary"
                                                                   style="border-radius: 10px; font-weight: 600;"
                                                                   onclick="return confirm('Rejeter ce signalement ?')">
                                                                    <i class="bi bi-x-circle me-2"></i>
                                                                    Rejeter
                                                                </a>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                    <!-- Modal d'avertissement -->
                                    <div class="modal fade" id="warnModal{{ report.id }}" tabindex="-1">
                                        <div class="modal-dialog">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h5 class="modal-title">Avertir l'utilisateur</h5>
                                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                                </div>
                                                <form method="post" action="{{ path('admin_report_warn', {id: report.id}) }}">
                                                    <div class="modal-body">
                                                        <p>Avertir <strong>{{ report.comment.user.firstName }} {{ report.comment.user.lastName }}</strong> ?</p>
                                                        <p class="text-warning">
                                                            <i class="bi bi-exclamation-triangle me-1"></i>
                                                            Warnings actuels : {{ report.comment.user.warningCount }}/3
                                                            {% if report.comment.user.warningCount >= 2 %}
                                                                <br><strong class="text-danger">L'utilisateur sera automatiquement banni après cet avertissement !</strong>
                                                            {% endif %}
                                                        </p>
                                                        <div class="mb-3">
                                                            <label class="form-label">Raison de l'avertissement</label>
                                                            <textarea name="reason" class="form-control" rows="3" 
                                                                      placeholder="Décrivez la raison de l'avertissement...">{{ report.reason ?: 'Commentaire inapproprié' }}</textarea>
                                                        </div>
                                                    </div>
                                                    <div class="modal-footer">
                                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                                                        <button type="submit" class="btn btn-warning">Avertir</button>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Modal de bannissement -->
                                    <div class="modal fade" id="banReportModal{{ report.id }}" tabindex="-1">
                                        <div class="modal-dialog">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h5 class="modal-title">Bannir l'utilisateur</h5>
                                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                                </div>
                                                <form method="post" action="{{ path('admin_report_ban', {id: report.id}) }}">
                                                    <div class="modal-body">
                                                        <p>Bannir définitivement <strong>{{ report.comment.user.firstName }} {{ report.comment.user.lastName }}</strong> ?</p>
                                                        <div class="mb-3">
                                                            <label class="form-label">Raison du bannissement</label>
                                                            <textarea name="reason" class="form-control" rows="3" 
                                                                      placeholder="Décrivez la raison du bannissement...">{{ report.reason ?: 'Commentaire gravement inapproprié' }}</textarea>
                                                        </div>
                                                    </div>
                                                    <div class="modal-footer">
                                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                                                        <button type="submit" class="btn btn-danger">Bannir</button>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            {% else %}
                                <div class="text-center py-5">
                                    <i class="bi bi-check-circle text-success" style="font-size: 4rem;"></i>
                                    <h5 class="mt-3 text-muted">Aucun signalement en attente</h5>
                                    <p class="text-muted">Tout est en ordre !</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}